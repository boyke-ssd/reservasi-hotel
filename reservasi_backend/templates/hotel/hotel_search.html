{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container mx-auto px-4 max-w-7xl py-6">
  <!-- Pencarian Sebelumnya (Di Atas) -->
  <div class="mb-6">
    <form method="GET" action="" aria-label="Hotel update form" class="bg-white rounded-lg shadow-xl p-6">
      <div class="flex flex-col lg:flex-row gap-4 items-stretch">
        <!-- Destination (Region) - Bisa Diubah -->
        <div class="flex-1 min-w-[200px] relative">
          <div class="bg-white backdrop-blur-md rounded-lg p-3 h-14 cursor-pointer hover:shadow-md transition-shadow border-2 border-[--teal-medium] group" onclick="toggleDestinationDropdown()" style="border-color: var(--teal-medium);">
            <div class="flex flex-col justify-center h-full">
              <span class="text-xs font-semibold text-[--teal-medium] uppercase tracking-wide group-hover:text-[--teal-dark]" style="color: var(--teal-medium);">Destinasi</span>
              <span class="text-sm font-medium text-[--teal-dark]" id="prevDestinationValue">
                {% if request.GET.destination_id and hotel_data %}
                  {% with hotel=hotel_data|first %}
                    {{ hotel.obj.region }} - {{ hotel.obj.name }}
                  {% endwith %}
                {% else %}
                  Pilih Hotel
                {% endif %}
              </span>
            </div>
          </div>
          <div id="prevDestinationDropdown" class="absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-lg border hidden z-50" style="border-color: var(--teal-medium);">
            <div class="border-t max-h-48 overflow-y-auto" style="border-color: var(--teal-medium);">
              {% for hotel in all_hotels %}
              <div class="p-3 hover:bg-[--mint-light] cursor-pointer" style="hover:bg-color: var(--mint-light);" onclick="selectPrevDestination('{{ hotel.name }}', '{{ hotel.id }}')">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-[--teal-dark]" style="color: var(--teal-dark);">{{ hotel.region }}</span>
                </div>
                <span class="text-xs text-[--teal-medium]" style="color: var(--teal-medium);">{{ hotel.name }}</span>
              </div>
              {% endfor %}
            </div>
          </div>
          <input type="hidden" name="destination_id" id="prevSelectedDestination" value="{{ request.GET.destination_id|default:'' }}">
        </div>
        <!-- Check-in (Range) -->
        <div class="flex-1 min-w-[280px] relative">
          <div class="bg-white backdrop-blur-md rounded-lg p-3 h-14 hover:shadow-md transition-shadow border-2 border-[--teal-medium] group">
            <div class="flex flex-col justify-center h-full">
              <span class="text-xs font-semibold text-[--teal-medium] uppercase tracking-wide group-hover:text-[--teal-dark]" style="color: var(--teal-medium);">Check-in</span>
              <input type="text" name="date_range" id="prevDateRange" class="text-sm font-medium text-[--teal-dark] w-full focus:outline-none" value="{{ request.GET.date_range|default:'Pilih rentang tanggal' }}" readonly>
            </div>
          </div>
        </div>
        <!-- Update Button -->
        <button type="submit" class="bg-[--teal-medium] text-white font-semibold px-6 py-3 rounded-lg hover:bg-[--teal-dark] transition-colors flex items-center gap-2 min-w-[120px] justify-center h-14" style="background-color: var(--teal-medium);">
          <span>Update</span>
        </button>
      </div>
    </form>
  </div>
  <!-- Layout Dua Kolom dengan Fixed Sidebar -->
  <div class="flex flex-col lg:flex-row gap-6 min-h-screen">
    <!-- Filter Section (Kiri) - Fixed Sidebar -->
    <div class="w-[280px] bg-white rounded-lg shadow-md p-4 top-6 h-fit">
      <h2 class="text-lg font-semibold text-[--teal-dark] mb-4 border-b pb-2" style="color: var(--teal-dark);">Filter</h2>
      <div class="space-y-4">
        <!-- Lokasi (Read-Only) -->
        <div>
          <label class="text-sm font-medium text-[--navy-dark] mb-2" style="color: var(--navy-dark);">Lokasi</label>
          <div class="p-2 bg-gray-100 rounded-md text-[--teal-dark]" style="color: var(--teal-dark);">
            {% if request.GET.destination_id and hotel_data %}
              {% with hotel=hotel_data|first %}
                {{ hotel.obj.region }}
              {% endwith %}
            {% else %}
              Tidak ada lokasi dipilih
            {% endif %}
          </div>
        </div>
        <!-- Star Rating (Checkbox di Bawah dengan Auto-Submit) -->
        <div>
          <label class="text-sm font-medium text-[--navy-dark] mb-2" style="color: var(--navy-dark);">Star Rating</label>
          <div class="space-y-2">
            {% for rating in '2345' %}
            <label class="flex items-center gap-2">
              <input type="checkbox" name="star_rating" value="{{ rating }}" {% if rating in request.GET.star_rating %}checked{% endif %} class="star-filter" style="accent-color: var(--teal-medium);" onchange="this.closest('form').submit()">
              <span class="text-sm text-[--teal-dark]" style="color: var(--teal-dark);">{{ rating }} â˜…</span>
            </label>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <!-- Hotel List Section (Kanan) -->
    <div class="flex-1">
      <!-- Jumlah Hotel Ditemukan -->
      <div class="bg-white rounded-lg p-4 mb-4 shadow-sm">
        <div class="flex justify-between items-center">
          <p class="text-sm font-medium text-[--teal-dark]" style="color: var(--teal-dark);">
            Ditemukan {{ hotel_data|length }} hotel
          </p>
          <div class="text-sm text-[--teal-dark]">
            <span>Urutkan: </span>
            <select class="border-none bg-transparent focus:outline-none text-[--teal-medium]" style="color: var(--teal-medium);">
              <option>Harga Terendah</option>
              <option>Rating Tertinggi</option>
            </select>
          </div>
        </div>
      </div>
      <div class="flex flex-col gap-4">
        {% for h in hotel_data %}
        {% if h.obj.id %}
        <a href="{% url 'hotel_detail' h.obj.id %}" class="block hover:shadow-lg transition overflow-hidden">
          <div class="bg-white shadow rounded-lg flex hover:shadow-xl transition duration-300">
            <!-- Image Section -->
            <div class="relative w-64 h-48">
              {% if h.image %}
                <img src="{{ h.image }}" alt="{{ h.obj.name }}" class="w-full h-full object-cover">
              {% else %}
                <img src="{% static 'images/no-image.png' %}" class="w-full h-full object-cover" alt="No Image">
              {% endif %}
              <div class="absolute top-2 left-2 bg-white text-[--navy-dark] text-xs px-2 py-1 rounded-md font-semibold shadow-md flex items-center gap-1" style="color: var(--navy-dark);">
                {% with rating=h.obj.average_rating|floatformat:1 %}
                  <span class="text-sm font-bold text-[--navy-dark]" style="color: var(--navy-dark);">{{ rating }}/5</span>
                  <span class="text-xs text-[--teal-dark] ml-1" style="color: var(--teal-dark);">{{ h.jumlah_ulasan|intcomma }} ulasan</span>
                {% endwith %}
              </div>
            </div>
            <!-- Content Section -->
            <div class="flex-1 p-4">
              <div class="flex flex-col h-full justify-between">
                <!-- Hotel Info -->
                <div>
                  <h3 class="font-semibold text-lg text-[--navy-dark] mb-1" style="color: var(--navy-dark);">{{ h.obj.name }}</h3>
                  <div class="flex items-center gap-2 mb-2">
                    <div class="flex">
                      {% for i in "12345"|slice:":h.obj.star_rating" %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[--teal-medium]" style="color: var(--teal-medium);" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 .587l3.668 7.568L24 9.75l-6 5.847L19.336 24 12 19.771 4.664 24 6 15.597 0 9.75l8.332-1.595z"/>
                        </svg>
                      {% endfor %}
                    </div>
                  </div>
                  <p class="text-sm text-[--teal-dark] mb-4" style="color: var(--teal-dark);">{{ h.obj.location }}</p>
                </div>
                
                <!-- Price Section -->
                <div class="flex justify-between items-end">
                  <div class="text-sm text-[--teal-dark]" style="color: var(--teal-dark);">
                    Per malam
                  </div>
                  <div class="text-right">
                    <p class="text-xl font-bold text-[--teal-medium]" style="color: var(--teal-medium);">
                      {% if h.harga_termurah %}
                       Rp {{ h.harga_termurah|intcomma }}
                      {% else %}
                        Tidak tersedia
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </a>
        {% endif %}
        {% empty %}
        <p class="text-[--teal-dark]" style="color: var(--teal-dark);">Tidak ada hotel yang ditemukan.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  // Initialize flatpickr for date range (disabled interaction in search page)
  flatpickr("#prevDateRange", {
    mode: "range",
    dateFormat: "Y-m-d",
    minDate: "today",
    defaultDate: null,
    theme: "material_blue",
    disableMobile: true,
    onChange: function(selectedDates, dateStr, instance) {
      if (selectedDates.length === 2) {
        const start = selectedDates[0].toLocaleDateString('en-CA');
        const end = selectedDates[1].toLocaleDateString('en-CA');
        instance.input.value = `${start} to ${end}`;
      } else {
        instance.input.value = dateStr;
      }
    }
  });

  // Function to select previous destination
  function selectPrevDestination(hotelName, hotelId) {
    document.getElementById('prevDestinationValue').textContent = hotelName;
    document.getElementById('prevSelectedDestination').value = hotelId;
    document.querySelector('form[aria-label="Hotel update form"]').submit(); // Auto-submit saat destinasi dipilih
  }

  function toggleDestinationDropdown() {
    const dropdown = document.getElementById('prevDestinationDropdown');
    dropdown.classList.toggle('hidden');
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('prevDestinationDropdown');
    const trigger = document.querySelector('[onclick="toggleDestinationDropdown()"]');
    if (dropdown && !dropdown.contains(e.target) && !trigger.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });

  // Star rating checkbox with auto-submit
  const starFilters = document.querySelectorAll('.star-filter');
  starFilters.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      this.closest('form').submit(); // Auto-submit on checkbox change
    });
  });
</script>
{% endblock %}