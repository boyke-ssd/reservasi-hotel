{% extends 'layout/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-6">
  <!-- Header -->
  <div class="bg-blue-600 text-white rounded-xl p-4 mb-6">
    <h2 class="text-lg font-semibold">Pilih > Detail > <span class="font-bold">Konfirmasi</span></h2>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- LEFT FORM -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Info Tamu -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-bold mb-4">Info Tamu</h3>
        <form method="POST">
          {% csrf_token %}
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" name="first_name" placeholder="Nama depan & tengah" value="{{ form.first_name.value|default_if_none:'' }}" required class="border px-3 py-2 rounded w-full">
            <input type="text" name="last_name" placeholder="Nama belakang" value="{{ form.last_name.value|default_if_none:'' }}" required class="border px-3 py-2 rounded w-full">
            <input type="email" name="email" placeholder="Email" value="{{ form.email.value|default_if_none:'' }}" required class="border px-3 py-2 rounded w-full">
            <input type="text" name="phone" placeholder="Nomor telepon (+62)" value="{{ form.phone.value|default_if_none:'' }}" required class="border px-3 py-2 rounded w-full">
          </div>
          <!-- Check-in, Check-out, dan Room dipindahkan ke dalam form -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="text-sm font-semibold text-gray-600">Check-in</label>
              <input type="date" name="check_in" value="{{ form.check_in.value|default_if_none:'' }}" required class="border px-3 py-2 rounded w-full">
            </div>
            <div>
              <label class="text-sm font-semibold text-gray-600">Check-out</label>
              <input type="date" name="check_out" value="{{ form.check_out.value|default_if_none:'' }}" required class="border px-3 py-2 rounded w-full">
            </div>
          </div>
          <div class="mt-4">
            <label class="text-sm font-semibold text-gray-600">Pilih Kamar</label>
            <select name="room" required class="border px-3 py-2 rounded w-full">
              <option value="">-- Pilih Kamar --</option>
              {% for r in rooms %}
              <option value="{{ r.id }}" {% if r.id == form.room.value|default_if_none:'' %}selected{% endif %}>
                {{ r.room_type.name }} (No. {{ r.number }})
              </option>
              {% endfor %}
            </select>
          </div>
          {% if form.errors %}
          <div class="bg-red-100 text-red-700 p-4 rounded mt-4">
            <p class="font-bold">Terjadi kesalahan:</p>
            <ul class="list-disc list-inside text-sm">
              {% for field, errors in form.errors.items %}
              <li>{{ field }}: {{ errors|striptags }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>

      <!-- Permintaan Khusus -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-bold mb-4">Permintaan Khusus <span class="text-sm text-gray-400">(Opsional)</span></h3>
        <div class="space-y-3">
          <div class="flex items-center gap-3">
            <label><input type="radio" name="bed_type" value="double"> 1 double bed</label>
            <label><input type="radio" name="bed_type" value="twin"> 2 single bed</label>
          </div>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="non_smoking"> <span>Utamakan kamar bebas rokok</span>
          </label>
          <textarea name="special_request" rows="3" class="w-full border rounded px-3 py-2" placeholder="Permintaan lain (opsional)"></textarea>
        </div>
      </div>
      
      <!-- METODE PEMBAYARAN -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-bold mb-4">Metode Pembayaran</h3>
        <div class="flex flex-col gap-2">
          <label><input type="radio" name="payment_method" value="credit" checked onclick="togglePaymentMethod()"> Kartu Kredit/Debit</label>
          <label><input type="radio" name="payment_method" value="ewallet" onclick="togglePaymentMethod()"> Dompet Digital (OVO, DANA, GoPay)</label>
        </div>

        <!-- Form Kartu Kredit -->
        <div id="credit-form" class="mt-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <input type="text" name="card_number" placeholder="Nomor kartu bank" class="border px-3 py-2 rounded w-full">
            <input type="text" name="card_name" placeholder="Nama pemegang kartu" class="border px-3 py-2 rounded w-full">
            <input type="month" name="expiry" class="border px-3 py-2 rounded w-full">
            <input type="text" name="cvv" placeholder="CVV/CVC" class="border px-3 py-2 rounded w-full">
          </div>
        </div>

        <!-- Form E-Wallet -->
        <div id="ewallet-form" class="mt-4 hidden">
          <label class="block mb-2 text-sm font-medium">Nomor Dompet Digital</label>
          <input type="text" name="ewallet_number" placeholder="08xxxxxxx (OVO/DANA/GoPay)" class="border px-3 py-2 rounded w-full">
        </div>
      </div>

      <!-- Rentang Tanggal -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-bold mb-4">Rentang Tanggal</h3>
        <div class="flex space-x-4">
          <div class="w-1/2">
            <label class="block text-sm font-semibold text-gray-600">Check-in</label>
            <input type="date" name="check_in" id="{{ form.check_in.id_for_label }}" value="{{ form.initial.check_in|default_if_none:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            {% if form.check_in.errors %}
              {% for error in form.check_in.errors %}
                <p class="text-red-500 text-xs">{{ error }}</p>
              {% endfor %}
            {% endif %}
          </div>
          <div class="w-1/2">
            <label class="block text-sm font-semibold text-gray-600">Check-out</label>
            <input type="date" name="check_out" id="{{ form.check_out.id_for_label }}" value="{{ form.initial.check_out|default_if_none:'' }}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
            {% if form.check_out.errors %}
              {% for error in form.check_out.errors %}
                <p class="text-red-500 text-xs">{{ error }}</p>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
        Langkah Terakhir
      </button>
      </form>
      <script>
        let isSubmitting = false;

        // Deteksi kalau user klik submit
        document.querySelector('form').addEventListener('submit', () => {
          isSubmitting = true;
        });

        function updateURL() {
          if (isSubmitting) return; // Jangan update URL kalau sedang submit

          const form = document.querySelector('form');
          const roomId = form.querySelector('select[name="room"]').value;
          const checkIn = form.querySelector('input[name="check_in"]').value;
          const checkOut = form.querySelector('input[name="check_out"]').value;

          const params = new URLSearchParams();
          if (roomId) params.set('room_id', roomId);
          if (checkIn) params.set('check_in', checkIn);
          if (checkOut) params.set('check_out', checkOut);

          // Replace halaman dengan parameter baru
          const newUrl = window.location.pathname + '?' + params.toString();
          window.location.href = newUrl;
        }

        // Jalankan hanya ketika user ubah check-in, check-out, atau kamar
        document.querySelector('input[name="check_in"]').addEventListener('change', updateURL);
        document.querySelector('input[name="check_out"]').addEventListener('change', updateURL);
        document.querySelector('select[name="room"]').addEventListener('change', updateURL);
      </script>


    </div>

    <!-- RIGHT SIDEBAR -->
    <div class="bg-white p-6 rounded-xl shadow h-fit">
      <div class="flex items-center gap-4 mb-4">
        <img src="{{ hotel.gallery.first.image.url }}" class="w-20 h-20 object-cover rounded" alt="">
        <div>
          <h4 class="font-bold">{{ hotel.name }}</h4>
          <p class="text-sm text-gray-500">{{ hotel.location }}</p>
        </div>
      </div>
    
      <hr class="my-4">
    
      <!-- Pilih Kamar -->
      <div class="mb-4">
        <label class="text-sm font-semibold text-gray-600">Pilih Kamar</label>
        <select name="room" id="{{ form.room.id_for_label }}" class="text-sm border border-gray-300 rounded px-3 py-2 w-full">
          <option value="">-- Pilih Kamar --</option>
          {% for r in form.fields.room.queryset %}
            <option value="{{ r.id }}" {% if r.id == room_obj.id %}selected{% endif %}>
              {{ r.room_type.name }} (No. {{ r.number }})
            </option>
          {% endfor %}
        </select>
        {% if form.room.errors %}
          {% for error in form.room.errors %}
            <p class="text-red-500 text-xs">{{ error }}</p>
          {% endfor %}
        {% endif %}
      </div>
    
      <hr class="my-4">
    
      <!-- Harga -->
      <p>Durasi: <strong>{{ durasi }} malam</strong></p>
      <p>Harga per malam: <strong>Rp {{ harga_kamar|intcomma }}</strong></p>
      <p>Total kamar: <strong>Rp {{ total_kamar|intcomma }}</strong></p>
      <p>Pajak & biaya lainnya (10%): <strong>Rp {{ pajak|intcomma }}</strong></p>
      <p class="font-bold text-blue-600 mt-2">Total: Rp {{ total_harga|intcomma }}</p>
    </div>
  </div>
</div>

<script>
  function togglePaymentMethod() {
    const selected = document.querySelector('input[name="payment_method"]:checked').value;
    const creditForm = document.getElementById('credit-form');
    const ewalletForm = document.getElementById('ewallet-form');

    if (selected === 'credit') {
      creditForm.classList.remove('hidden');
      ewalletForm.classList.add('hidden');
    } else {
      creditForm.classList.add('hidden');
      ewalletForm.classList.remove('hidden');
    }
  }

  document.addEventListener('DOMContentLoaded', togglePaymentMethod);
</script>
{% endblock %}